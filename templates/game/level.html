{% extends 'base.html' %}
{% block title %}Level {{ level.level_number }} - Mystery Game{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-900 via-purple-900 to-indigo-900 relative overflow-hidden">
    <!-- Desktop Background -->
    <div class="absolute inset-0 bg-gradient-to-br from-slate-800 via-blue-900 to-purple-900"></div>
    
    <!-- Desktop Icons -->
    <div class="absolute top-4 left-4 z-20 space-y-4">
        <div class="desktop-icon cursor-pointer" onclick="minimizeAllWindows()">
            <div class="w-16 h-16 bg-blue-600 rounded-lg flex items-center justify-center hover:bg-blue-500 transition-colors shadow-lg">
                <i class="fas fa-desktop text-white text-2xl"></i>
            </div>
            <span class="text-white text-xs mt-1 block text-center">Desktop</span>
        </div>
        
        <div class="desktop-icon cursor-pointer" onclick="openWindow('notepad')">
            <div class="w-16 h-16 bg-yellow-600 rounded-lg flex items-center justify-center hover:bg-yellow-500 transition-colors shadow-lg">
                <i class="fas fa-sticky-note text-white text-2xl"></i>
            </div>
            <span class="text-white text-xs mt-1 block text-center">Notepad</span>
        </div>
        
        <div class="desktop-icon cursor-pointer" onclick="openWindow('browser')">
            <div class="w-16 h-16 bg-cyan-600 rounded-lg flex items-center justify-center hover:bg-cyan-500 transition-colors shadow-lg">
                <i class="fas fa-globe text-white text-2xl"></i>
            </div>
            <span class="text-white text-xs mt-1 block text-center">Browser</span>
        </div>
        
        <div class="desktop-icon cursor-pointer" onclick="openWindow('social')">
            <div class="w-16 h-16 bg-blue-500 rounded-lg flex items-center justify-center hover:bg-blue-400 transition-colors shadow-lg">
                <i class="fab fa-facebook-f text-white text-2xl"></i>
            </div>
            <span class="text-white text-xs mt-1 block text-center">Social</span>
        </div>
        
        <div class="desktop-icon cursor-pointer" onclick="openWindow('expert')">
            <div class="w-16 h-16 bg-purple-600 rounded-lg flex items-center justify-center hover:bg-purple-500 transition-colors shadow-lg">
                <i class="fas fa-user-graduate text-white text-2xl"></i>
            </div>
            <span class="text-white text-xs mt-1 block text-center">Experts</span>
        </div>
    </div>

    <!-- Notepad Window -->
    <div id="notepad-window" class="desktop-window absolute top-20 left-24 w-96 h-80 bg-white rounded-lg shadow-2xl border border-gray-300 hidden">
        <div class="window-header bg-gradient-to-r from-yellow-400 to-yellow-600 p-3 rounded-t-lg flex items-center justify-between cursor-move">
            <div class="flex items-center space-x-2">
                <i class="fas fa-sticky-note text-white"></i>
                <span class="text-white font-semibold text-sm">Investigation Notes</span>
            </div>
            <div class="flex items-center space-x-1">
                <button onclick="minimizeWindow('notepad')" class="w-6 h-6 bg-yellow-300 hover:bg-yellow-200 rounded text-xs flex items-center justify-center">
                    <i class="fas fa-minus text-yellow-800"></i>
                </button>
                <button onclick="closeWindow('notepad')" class="w-6 h-6 bg-red-500 hover:bg-red-400 rounded text-xs flex items-center justify-center">
                    <i class="fas fa-times text-white"></i>
                </button>
            </div>
        </div>
        <div class="p-4 bg-yellow-50 h-64 overflow-y-auto">
            <div class="border-l-4 border-red-500 pl-4 mb-4">
                <h3 class="text-lg font-bold text-gray-800 mb-2">CASE FILE: LEVEL {{ level.level_number }}</h3>
                <div class="bg-red-100 border border-red-300 rounded p-3 mb-3">
                    <p class="text-red-800 text-sm font-semibold">‚ö†Ô∏è URGENT INVESTIGATION</p>
                </div>
                <h4 class="text-xl font-bold text-gray-900 mb-3">{{ level.headline }}</h4>
                {% if level.article_snippet %}
                <div class="bg-gray-100 border-l-4 border-gray-400 p-3 mb-3">
                    <p class="text-gray-700 text-sm"><strong>Details:</strong> {{ level.article_snippet }}</p>
                </div>
                {% endif %}
                
                <!-- Investigation Checklist -->
                <div class="bg-blue-100 border border-blue-400 rounded p-3 mb-3">
                    <h5 class="text-blue-800 font-semibold text-sm mb-2">üîç CROSS-REFERENCE CHECKLIST:</h5>
                    <ul class="text-blue-700 text-xs space-y-1">
                        <li>‚òê Verify official sources vs unofficial claims</li>
                        <li>‚òê Check timeline consistency across sources</li>
                        <li>‚òê Compare credibility scores and citations</li>
                        <li>‚òê Look for verification badges on social media</li>
                        <li>‚òê Analyze expert opinions for red flags</li>
                        <li>‚òê Cross-check specific facts and figures</li>
                    </ul>
                </div>
                
                <div class="bg-yellow-200 border border-yellow-600 rounded p-3">
                    <p class="text-sm text-gray-800"><strong>üéØ Your Mission:</strong> Use evidence from ALL sources to determine if this news is REAL or FAKE. Look for contradictions!</p>
                    <p class="text-xs text-gray-600 mt-2">‚è±Ô∏è Time remaining: <span id="timer-display">{{ level.time_limit // 60 }}:{{ "%02d"|format(level.time_limit % 60) }}</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Browser Window -->
    <div id="browser-window" class="desktop-window absolute top-16 left-1/3 w-2/3 h-5/6 bg-white rounded-lg shadow-2xl border border-gray-300 hidden">
        <div class="window-header bg-gradient-to-r from-gray-600 to-gray-800 p-3 rounded-t-lg flex items-center justify-between cursor-move">
            <div class="flex items-center space-x-2">
                <i class="fas fa-globe text-white"></i>
                <span class="text-white font-semibold text-sm">TruthBrowser</span>
            </div>
            <div class="flex items-center space-x-1">
                <button onclick="minimizeWindow('browser')" class="w-6 h-6 bg-yellow-300 hover:bg-yellow-200 rounded text-xs flex items-center justify-center">
                    <i class="fas fa-minus text-yellow-800"></i>
                </button>
                <button onclick="closeWindow('browser')" class="w-6 h-6 bg-red-500 hover:bg-red-400 rounded text-xs flex items-center justify-center">
                    <i class="fas fa-times text-white"></i>
                </button>
            </div>
        </div>
        <div class="bg-gray-100 p-2 flex items-center space-x-2 border-b">
            <div class="flex space-x-1">
                <button class="w-8 h-8 bg-gray-300 hover:bg-gray-200 rounded flex items-center justify-center">
                    <i class="fas fa-arrow-left text-gray-600 text-xs"></i>
                </button>
                <button class="w-8 h-8 bg-gray-300 hover:bg-gray-200 rounded flex items-center justify-center">
                    <i class="fas fa-arrow-right text-gray-600 text-xs"></i>
                </button>
                <button class="w-8 h-8 bg-gray-300 hover:bg-gray-200 rounded flex items-center justify-center">
                    <i class="fas fa-redo text-gray-600 text-xs"></i>
                </button>
            </div>
            <div class="flex-1 bg-white border border-gray-300 rounded px-3 py-1">
                <span class="text-gray-600 text-sm">üì∞ News Sources - Fact Check Database</span>
            </div>
        </div>
        <div class="p-4 h-full overflow-y-auto bg-white" id="browser-content">
            <div class="text-center py-8">
                <i class="fas fa-spinner animate-spin text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-600">Click "Load News Articles" to begin investigation...</p>
                <button onclick="loadEvidence('news')" class="mt-4 bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg transition-colors">
                    <i class="fas fa-download mr-2"></i>Load News Articles
                </button>
            </div>
        </div>
    </div>

    <!-- Social Media Window -->
    <div id="social-window" class="desktop-window absolute top-32 right-4 w-96 h-96 bg-white rounded-lg shadow-2xl border border-gray-300 hidden">
        <div class="window-header bg-gradient-to-r from-blue-500 to-blue-700 p-3 rounded-t-lg flex items-center justify-between cursor-move">
            <div class="flex items-center space-x-2">
                <i class="fab fa-facebook-f text-white"></i>
                <span class="text-white font-semibold text-sm">Social Feed</span>
            </div>
            <div class="flex items-center space-x-1">
                <button onclick="minimizeWindow('social')" class="w-6 h-6 bg-yellow-300 hover:bg-yellow-200 rounded text-xs flex items-center justify-center">
                    <i class="fas fa-minus text-yellow-800"></i>
                </button>
                <button onclick="closeWindow('social')" class="w-6 h-6 bg-red-500 hover:bg-red-400 rounded text-xs flex items-center justify-center">
                    <i class="fas fa-times text-white"></i>
                </button>
            </div>
        </div>
        <div class="p-4 h-80 overflow-y-auto bg-blue-50" id="social-content">
            <div class="text-center py-8">
                <i class="fab fa-facebook-f text-4xl text-blue-400 mb-4"></i>
                <p class="text-gray-600">Check what people are saying...</p>
                <button onclick="loadEvidence('facebook')" class="mt-4 bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg transition-colors">
                    <i class="fas fa-comments mr-2"></i>Load Social Posts
                </button>
            </div>
        </div>
    </div>

    <!-- Expert Window -->
    <div id="expert-window" class="desktop-window absolute top-48 left-1/2 w-80 h-72 bg-white rounded-lg shadow-2xl border border-gray-300 hidden">
        <div class="window-header bg-gradient-to-r from-purple-500 to-purple-700 p-3 rounded-t-lg flex items-center justify-between cursor-move">
            <div class="flex items-center space-x-2">
                <i class="fas fa-user-graduate text-white"></i>
                <span class="text-white font-semibold text-sm">Expert Analysis</span>
            </div>
            <div class="flex items-center space-x-1">
                <button onclick="minimizeWindow('expert')" class="w-6 h-6 bg-yellow-300 hover:bg-yellow-200 rounded text-xs flex items-center justify-center">
                    <i class="fas fa-minus text-yellow-800"></i>
                </button>
                <button onclick="closeWindow('expert')" class="w-6 h-6 bg-red-500 hover:bg-red-400 rounded text-xs flex items-center justify-center">
                    <i class="fas fa-times text-white"></i>
                </button>
            </div>
        </div>
        <div class="p-4 h-56 overflow-y-auto bg-purple-50" id="expert-content">
            <div class="text-center py-8">
                <i class="fas fa-user-graduate text-4xl text-purple-400 mb-4"></i>
                <p class="text-gray-600">Consult expert opinions...</p>
                <button onclick="loadEvidence('experts')" class="mt-4 bg-purple-600 hover:bg-purple-500 text-white px-6 py-2 rounded-lg transition-colors">
                    <i class="fas fa-university mr-2"></i>Load Expert Opinions
                </button>
            </div>
        </div>
    </div>

    <!-- Desktop Taskbar -->
    <div class="absolute bottom-0 left-0 right-0 bg-gray-800 h-12 flex items-center justify-between px-4 z-30 border-t border-gray-600">
        <!-- Start Menu -->
        <div class="flex items-center space-x-4">
            <button class="bg-blue-600 hover:bg-blue-500 p-2 rounded transition-colors" onclick="toggleStartMenu()">
                <i class="fas fa-search text-white"></i>
            </button>
            <span class="text-white text-sm font-semibold">TruthDetective OS</span>
        </div>

        <!-- Running Applications -->
        <div class="flex items-center space-x-2" id="taskbar-apps">
            <button id="notepad-task" class="taskbar-app hidden bg-yellow-600 hover:bg-yellow-500 px-3 py-1 rounded text-white text-xs transition-colors" onclick="toggleWindow('notepad')">
                <i class="fas fa-sticky-note mr-1"></i>Notes
            </button>
            <button id="browser-task" class="taskbar-app hidden bg-gray-600 hover:bg-gray-500 px-3 py-1 rounded text-white text-xs transition-colors" onclick="toggleWindow('browser')">
                <i class="fas fa-globe mr-1"></i>Browser
            </button>
            <button id="social-task" class="taskbar-app hidden bg-blue-600 hover:bg-blue-500 px-3 py-1 rounded text-white text-xs transition-colors" onclick="toggleWindow('social')">
                <i class="fab fa-facebook-f mr-1"></i>Social
            </button>
            <button id="expert-task" class="taskbar-app hidden bg-purple-600 hover:bg-purple-500 px-3 py-1 rounded text-white text-xs transition-colors" onclick="toggleWindow('expert')">
                <i class="fas fa-user-graduate mr-1"></i>Expert
            </button>
        </div>

        <!-- System Tray -->
        <div class="flex items-center space-x-4">
            <div class="text-white text-sm" id="system-time"></div>
            <div class="flex items-center space-x-2">
                <button class="text-white hover:text-gray-300 transition-colors" title="Submit Answer" onclick="showSubmitDialog()">
                    <i class="fas fa-check-circle text-green-400"></i>
                </button>
                <button class="text-white hover:text-gray-300 transition-colors" title="Evidence: 0/3" id="evidence-indicator">
                    <i class="fas fa-folder text-yellow-400"></i>
                    <span class="text-xs ml-1" id="evidence-count">0/3</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Submit Dialog -->
    <div id="submit-dialog" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center">
            <div class="fixed inset-0 transition-opacity bg-black/80 backdrop-blur-sm" onclick="closeSubmitDialog()"></div>
            <div class="relative inline-block w-full max-w-md my-8 overflow-hidden text-left align-middle transition-all transform bg-white rounded-lg shadow-xl z-10">
                <div class="bg-gradient-to-r from-orange-500 to-red-600 p-4 text-white">
                    <h3 class="text-lg font-semibold flex items-center">
                        <i class="fas fa-gavel mr-2"></i>Final Decision
                    </h3>
                </div>
                <div class="p-6">
                    <p class="text-gray-700 mb-6">Based on your investigation, is this news REAL or FAKE?</p>
                    
                    <div class="space-y-4 mb-6">
                        <label class="decision-option block cursor-pointer">
                            <input type="radio" name="final-decision" value="true" class="sr-only">
                            <div class="decision-card bg-green-100 border-2 border-green-300 rounded-lg p-4 hover:border-green-500 transition-all duration-300">
                                <div class="flex items-center space-x-3">
                                    <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                                    <div>
                                        <div class="text-green-800 font-semibold">REAL NEWS</div>
                                        <div class="text-green-600 text-sm">This story is legitimate</div>
                                    </div>
                                </div>
                            </div>
                        </label>

                        <label class="decision-option block cursor-pointer">
                            <input type="radio" name="final-decision" value="false" class="sr-only">
                            <div class="decision-card bg-red-100 border-2 border-red-300 rounded-lg p-4 hover:border-red-500 transition-all duration-300">
                                <div class="flex items-center space-x-3">
                                    <i class="fas fa-times-circle text-red-600 text-2xl"></i>
                                    <div>
                                        <div class="text-red-800 font-semibold">FAKE NEWS</div>
                                        <div class="text-red-600 text-sm">This story is fabricated</div>
                                    </div>
                                </div>
                            </div>
                        </label>
                    </div>

                    <div class="flex space-x-4">
                        <button onclick="closeSubmitDialog()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-4 rounded transition-colors">
                            Cancel
                        </button>
                        <button id="final-submit-btn" disabled onclick="submitFinalAnswer()" class="flex-1 bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-400 hover:to-red-500 disabled:from-gray-400 disabled:to-gray-500 text-white font-bold py-3 px-4 rounded transition-all duration-300 disabled:cursor-not-allowed">
                            Submit Final Answer
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let gameTimer;
let timeLeft = {{ level.time_limit }};
let evidenceGathered = [];
const sessionId = {{ session_id }};
const windows = {};

// Initialize desktop
document.addEventListener('DOMContentLoaded', function() {
    startTimer();
    updateSystemTime();
    setInterval(updateSystemTime, 1000);
    
    // Show fresh content generation notice
    showFreshContentNotice();
    
    // Open notepad by default after notice
    setTimeout(() => openWindow('notepad'), 2000);
    
    // Decision form handling
    const decisionOptions = document.querySelectorAll('input[name="final-decision"]');
    const submitBtn = document.getElementById('final-submit-btn');
    
    decisionOptions.forEach(option => {
        option.addEventListener('change', function() {
            submitBtn.disabled = false;
            
            // Update visual selection
            document.querySelectorAll('.decision-card').forEach(card => {
                card.classList.remove('border-blue-500', 'bg-blue-100');
            });
            
            const selectedCard = this.closest('.decision-option').querySelector('.decision-card');
            selectedCard.classList.add('border-blue-500', 'bg-blue-100');
        });
    });
});

function showFreshContentNotice() {
    const notification = document.createElement('div');
    notification.className = 'fixed top-20 right-4 z-50 max-w-sm w-full transform transition-all duration-300 translate-x-full';
    
    notification.innerHTML = `
        <div class="bg-gradient-to-r from-orange-500/90 to-red-500/90 backdrop-blur-lg border border-white/20 rounded-xl p-4 shadow-xl">
            <div class="flex items-center space-x-3">
                <i class="fas fa-magic text-white text-lg animate-pulse"></i>
                <div>
                    <p class="text-white text-sm font-medium">üî• Fresh Content Generated!</p>
                    <p class="text-white/80 text-xs">Brand new scenario created just for this session</p>
                </div>
                <button onclick="this.closest('.fixed').remove()" class="text-white/80 hover:text-white ml-auto">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Animate in
    setTimeout(() => {
        notification.classList.remove('translate-x-full');
    }, 500);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => notification.remove(), 300);
    }, 5000);
}

// Timer functionality
function startTimer() {
    gameTimer = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        
        if (timeLeft <= 0) {
            clearInterval(gameTimer);
            submitAnswer(true);
        }
    }, 1000);
}

function updateTimerDisplay() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    const timerEl = document.getElementById('timer-display');
    if (timerEl) {
        timerEl.textContent = display;
        if (timeLeft <= 60) {
            timerEl.classList.add('text-red-600', 'font-bold');
        }
    }
}

function updateSystemTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    document.getElementById('system-time').textContent = timeString;
}

// Window management
function openWindow(windowId) {
    const window = document.getElementById(windowId + '-window');
    const taskButton = document.getElementById(windowId + '-task');
    
    if (window && taskButton) {
        window.classList.remove('hidden');
        taskButton.classList.remove('hidden');
        windows[windowId] = { minimized: false, element: window };
        bringToFront(window);
    }
}

function closeWindow(windowId) {
    const window = document.getElementById(windowId + '-window');
    const taskButton = document.getElementById(windowId + '-task');
    
    if (window && taskButton) {
        window.classList.add('hidden');
        taskButton.classList.add('hidden');
        delete windows[windowId];
    }
}

function minimizeWindow(windowId) {
    const window = document.getElementById(windowId + '-window');
    if (window) {
        window.style.display = 'none';
        windows[windowId].minimized = true;
    }
}

function toggleWindow(windowId) {
    const window = document.getElementById(windowId + '-window');
    if (window && windows[windowId]) {
        if (windows[windowId].minimized || window.style.display === 'none') {
            window.style.display = 'block';
            windows[windowId].minimized = false;
            bringToFront(window);
        } else {
            minimizeWindow(windowId);
        }
    }
}

function bringToFront(window) {
    // Reset all windows z-index
    Object.values(windows).forEach(w => {
        if (w.element) w.element.style.zIndex = '10';
    });
    // Bring selected window to front
    window.style.zIndex = '20';
}

function minimizeAllWindows() {
    Object.keys(windows).forEach(windowId => {
        minimizeWindow(windowId);
    });
}

// Evidence loading
function loadEvidence(type) {
    // Show loading state
    const contentId = type === 'facebook' ? 'social-content' : 
                     type === 'news' ? 'browser-content' : 'expert-content';
    const content = document.getElementById(contentId);
    
    content.innerHTML = `
        <div class="text-center py-8">
            <i class="fas fa-spinner animate-spin text-4xl text-gray-400 mb-4"></i>
            <p class="text-gray-600">Loading ${type === 'facebook' ? 'social media posts' : type === 'news' ? 'news articles' : 'expert opinions'}...</p>
        </div>
    `;
    
    fetch(`/game/api/evidence/${sessionId}/${type}`)
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Evidence data received:', data);
            
            if (data.error) {
                content.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
                        <p class="text-red-600">${data.error}</p>
                        <button onclick="loadEvidence('${type}')" class="mt-4 bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg transition-colors">
                            <i class="fas fa-redo mr-2"></i>Try Again
                        </button>
                    </div>
                `;
                return;
            }
            
            // Ensure evidence is an array
            let evidence = data.evidence;
            if (!Array.isArray(evidence)) {
                console.error('Evidence is not an array:', evidence);
                evidence = [];
            }
            
            displayEvidence(type, evidence);
            
            if (!evidenceGathered.includes(type)) {
                evidenceGathered.push(type);
                updateEvidenceCount();
            }
        })
        .catch(error => {
            console.error('Error loading evidence:', error);
            content.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-4"></i>
                    <p class="text-red-600">Failed to load evidence: ${error.message}</p>
                    <p class="text-gray-500 text-sm mt-2">Session ID: ${sessionId}, Type: ${type}</p>
                    <button onclick="loadEvidence('${type}')" class="mt-4 bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg transition-colors">
                        <i class="fas fa-redo mr-2"></i>Try Again
                    </button>
                </div>
            `;
        });
}

function updateEvidenceCount() {
    document.getElementById('evidence-count').textContent = `${evidenceGathered.length}/3`;
    
    // Update the evidence indicator title
    const indicator = document.getElementById('evidence-indicator');
    if (indicator) {
        indicator.title = `Evidence: ${evidenceGathered.length}/3`;
    }
}

// Display evidence in the respective window
function displayEvidence(type, evidence) {
    const contentId = type === 'facebook' ? 'social-content' : 
                     type === 'news' ? 'browser-content' : 'expert-content';
    const content = document.getElementById(contentId);
    
    if (!Array.isArray(evidence) || evidence.length === 0) {
        content.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-info-circle text-4xl text-gray-400 mb-4"></i>
                <p class="text-gray-600">No ${type} evidence available for this case.</p>
            </div>
        `;
        return;
    }
    
    content.innerHTML = generateEvidenceHTML(type, evidence);
}

function generateEvidenceHTML(type, evidence) {
    if (!Array.isArray(evidence)) {
        console.error('Evidence is not an array in generateEvidenceHTML:', evidence);
        return '<p class="text-gray-600">Error loading evidence data</p>';
    }
    
    if (type === 'facebook') {
        return evidence.map(post => {
            // Ensure post object has required properties
            const author = post.author || 'Unknown User';
            const content_text = post.content || 'No content available';
            const likes = post.likes || 0;
            const shares = post.shares || 0;
            const time = post.time || 'Unknown time';
            const verified = post.verified || false;
            const supports_claim = post.supports_claim !== undefined ? post.supports_claim : true;
            
            return `
                <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex items-center space-x-3 mb-3">
                        <div class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-user text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-2">
                                <div class="text-gray-900 font-semibold text-sm truncate">${author}</div>
                                ${verified ? '<i class="fas fa-check-circle text-blue-500 flex-shrink-0" title="Verified Account"></i>' : ''}
                            </div>
                            <div class="text-gray-500 text-xs">${time}</div>
                        </div>
                    </div>
                    <p class="text-gray-800 mb-3 text-sm leading-relaxed">${content_text}</p>
                    <div class="flex items-center space-x-4 text-xs text-gray-500">
                        <span class="flex items-center space-x-1">
                            <i class="fas fa-thumbs-up text-blue-500"></i>
                            <span>${likes}</span>
                        </span>
                        <span class="flex items-center space-x-1">
                            <i class="fas fa-share text-gray-400"></i>
                            <span>${shares}</span>
                        </span>
                        <span class="ml-auto px-2 py-1 rounded-full text-xs ${supports_claim ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                            ${supports_claim ? 'Supports' : 'Questions'}
                        </span>
                    </div>
                </div>
            `;
        }).join('');
    } else if (type === 'news') {
        return evidence.map(article => {
            // Ensure article object has required properties
            const title = article.title || 'No title available';
            const source = article.source || 'Unknown source';
            const author = article.author || 'Unknown author';
            const date = article.date || 'Unknown date';
            const excerpt = article.excerpt || 'No excerpt available';
            const credibility_score = article.credibility_score || 0;
            const citations = article.citations || 0;
            const supports_claim = article.supports_claim !== undefined ? article.supports_claim : true;
            
            return `
                <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between mb-3">
                        <h4 class="text-gray-900 font-semibold text-sm leading-tight flex-1 pr-4">${title}</h4>
                        <div class="text-right flex-shrink-0">
                            <div class="text-green-600 text-xs font-semibold">Credibility: ${credibility_score}/10</div>
                            <div class="text-gray-500 text-xs">${citations} citations</div>
                        </div>
                    </div>
                    <div class="text-gray-600 text-xs mb-2 flex flex-wrap items-center gap-1">
                        <span class="font-medium">${source}</span>
                        <span>‚Ä¢</span>
                        <span>${author}</span>
                        <span>‚Ä¢</span>
                        <span>${date}</span>
                    </div>
                    <p class="text-gray-800 text-sm leading-relaxed mb-2">${excerpt}</p>
                    <div class="flex justify-between items-center">
                        <span class="px-2 py-1 rounded-full text-xs ${supports_claim ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                            ${supports_claim ? 'Supports Claim' : 'Contradicts Claim'}
                        </span>
                        <div class="text-xs text-gray-500">
                            Credibility: ${credibility_score >= 8 ? 'High' : credibility_score >= 6 ? 'Medium' : 'Low'}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    } else if (type === 'experts') {
        return evidence.map(expert => {
            // Ensure expert object has required properties
            const expert_name = expert.expert || 'Unknown Expert';
            const credentials = expert.credentials || 'Unknown credentials';
            const institution = expert.institution || 'Unknown institution';
            const quote = expert.quote || 'No quote available';
            const supports_claim = expert.supports_claim !== undefined ? expert.supports_claim : true;
            
            return `
                <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex items-center space-x-3 mb-3">
                        <div class="w-10 h-10 bg-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-graduation-cap text-white"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="text-gray-900 font-semibold text-sm truncate">${expert_name}</div>
                            <div class="text-gray-600 text-xs truncate">${credentials}</div>
                            <div class="text-gray-500 text-xs truncate">${institution}</div>
                        </div>
                    </div>
                    <blockquote class="text-gray-800 text-sm italic leading-relaxed mb-3 border-l-4 border-purple-200 pl-3">
                        "${quote}"
                    </blockquote>
                    <div class="flex justify-end">
                        <span class="px-2 py-1 rounded-full text-xs ${supports_claim ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                            ${supports_claim ? 'Supports' : 'Questions'} Claim
                        </span>
                    </div>
                </div>
            `;
        }).join('');
    }
    return '<p class="text-gray-600">Unknown evidence type</p>';
}

// Submit functionality
function showSubmitDialog() {
    const dialog = document.getElementById('submit-dialog');
    dialog.classList.remove('hidden');
    // Prevent body scroll when modal is open
    document.body.style.overflow = 'hidden';
    
    // Focus on the modal for accessibility
    setTimeout(() => {
        const firstRadio = dialog.querySelector('input[name="final-decision"]');
        if (firstRadio) {
            firstRadio.focus();
        }
    }, 100);
}

function closeSubmitDialog() {
    const dialog = document.getElementById('submit-dialog');
    dialog.classList.add('hidden');
    // Restore body scroll
    document.body.style.overflow = '';
    
    // Reset form
    const radios = document.querySelectorAll('input[name="final-decision"]');
    radios.forEach(radio => radio.checked = false);
    
    // Reset decision cards
    document.querySelectorAll('.decision-card').forEach(card => {
        card.classList.remove('border-blue-500', 'bg-blue-100');
    });
    
    // Disable submit button
    document.getElementById('final-submit-btn').disabled = true;
}

function submitFinalAnswer() {
    const selectedDecision = document.querySelector('input[name="final-decision"]:checked');
    if (!selectedDecision) {
        alert('Please select an answer before submitting.');
        return;
    }
    
    const userAnswer = selectedDecision.value === 'true';
    
    // Disable the submit button to prevent double submission
    const submitBtn = document.getElementById('final-submit-btn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner animate-spin mr-2"></i>Submitting...';
    
    clearInterval(gameTimer);
    
    const data = {
        answer: userAnswer,
        time_taken: {{ level.time_limit }} - timeLeft,
        evidence_gathered: evidenceGathered
    };
    
    fetch(`/game/api/submit/${sessionId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        showResult(result);
    })
    .catch(error => {
        console.error('Error:', error);
        // Re-enable button on error
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Submit Final Answer';
        alert('Failed to submit answer. Please try again.');
    });
}

function showResult(result) {
    closeSubmitDialog();
    
    const resultWindow = document.createElement('div');
    resultWindow.className = 'fixed inset-0 z-50 overflow-y-auto';
    
    // Determine next level URL
    const currentLevel = {{ level.level_number }};
    const gameHomeUrl = '{{ url_for("game.game_home") }}';
    
    // Determine unlock message
    let unlockMessage = '';
    if (result.next_level_unlocked) {
        unlockMessage = `<div class="bg-green-500/20 border border-green-500/50 rounded-xl p-4 mb-4">
            <div class="flex items-center space-x-3">
                <i class="fas fa-unlock text-green-400 text-xl"></i>
                <p class="text-green-300 font-medium">Level ${currentLevel + 1} unlocked!</p>
            </div>
        </div>`;
    }
    
    // Show attempt info and fresh content notice
    const attemptInfo = result.attempts > 1 ? 
        `<p class="text-gray-400 text-sm mb-4">Attempt #${result.attempts}</p>` : '';
    
    const freshContentNotice = `<div class="bg-gradient-to-r from-orange-500/20 to-red-500/20 border border-orange-500/50 rounded-xl p-3 mb-4">
        <div class="flex items-center space-x-2">
            <i class="fas fa-magic text-orange-400"></i>
            <p class="text-orange-300 text-sm">Fresh content was generated for this session - each play creates a unique scenario!</p>
        </div>
    </div>`;
    
    resultWindow.innerHTML = `
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center">
            <div class="fixed inset-0 transition-opacity bg-black/80 backdrop-blur-sm"></div>
            <div class="relative inline-block w-full max-w-md my-8 overflow-hidden text-left align-middle transition-all transform bg-white rounded-lg shadow-xl z-10">
                <div class="bg-gradient-to-r ${result.correct ? 'from-green-500 to-green-700' : 'from-red-500 to-red-700'} p-4 text-white">
                    <h3 class="text-lg font-semibold flex items-center">
                        <i class="fas ${result.correct ? 'fa-check-circle' : 'fa-times-circle'} mr-2"></i>
                        ${result.correct ? 'Correct!' : 'Incorrect!'}
                    </h3>
                </div>
                <div class="p-6 text-center">
                    ${attemptInfo}
                    ${unlockMessage}
                    ${freshContentNotice}
                    <p class="text-gray-700 mb-4">${result.explanation}</p>
                    <div class="bg-gray-100 rounded-lg p-4 mb-6">
                        <div class="text-2xl font-bold text-blue-600 mb-1">${result.score}</div>
                        <div class="text-gray-600 text-sm">Points Earned</div>
                        <div class="text-xs text-gray-500 mt-1">Evidence gathered: ${result.total_evidence}/3</div>
                    </div>
                    <div class="flex space-x-4">
                        <a href="${gameHomeUrl}" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-semibold py-3 px-4 rounded transition-colors text-center">
                            Back to Levels
                        </a>
                        ${result.correct && currentLevel < 10 ? 
                            `<a href="${gameHomeUrl}" class="flex-1 bg-orange-600 hover:bg-orange-500 text-white font-semibold py-3 px-4 rounded transition-colors text-center">
                                ${result.next_level_unlocked ? 'Continue' : 'Next Level'}
                            </a>` : 
                            `<button onclick="location.reload()" class="flex-1 bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-400 hover:to-red-500 text-white font-semibold py-3 px-4 rounded transition-colors">
                                üîÑ New Scenario
                            </button>`
                        }
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(resultWindow);
}

// Make windows draggable
document.addEventListener('mousedown', function(e) {
    if (e.target.closest('.window-header')) {
        const window = e.target.closest('.desktop-window');
        let isDown = true;
        let offset = [
            window.offsetLeft - e.clientX,
            window.offsetTop - e.clientY
        ];
        
        function mouseMoveHandler(e) {
            if (isDown) {
                window.style.left = (e.clientX + offset[0]) + 'px';
                window.style.top = (e.clientY + offset[1]) + 'px';
            }
        }
        
        function mouseUpHandler() {
            isDown = false;
            document.removeEventListener('mousemove', mouseMoveHandler);
            document.removeEventListener('mouseup', mouseUpHandler);
        }
        
        document.addEventListener('mousemove', mouseMoveHandler);
        document.addEventListener('mouseup', mouseUpHandler);
        
        bringToFront(window);
    }
});

// Add keyboard support for modal
document.addEventListener('keydown', function(event) {
    const submitDialog = document.getElementById('submit-dialog');
    if (!submitDialog.classList.contains('hidden')) {
        if (event.key === 'Escape') {
            closeSubmitDialog();
        }
    }
});

// Prevent clicks on modal content from closing the dialog
document.addEventListener('click', function(event) {
    const submitDialog = document.getElementById('submit-dialog');
    if (!submitDialog.classList.contains('hidden')) {
        const modalContent = submitDialog.querySelector('.bg-white');
        if (modalContent && !modalContent.contains(event.target)) {
            // Only close if clicking outside the modal content
            if (event.target.classList.contains('bg-black/80')) {
                closeSubmitDialog();
            }
        }
    }
});
</script>

<style>
.desktop-window {
    resize: both;
    overflow: auto;
    min-width: 300px;
    min-height: 200px;
}

.window-header {
    user-select: none;
}

.decision-option input:checked + .decision-card {
    @apply border-blue-500 bg-blue-100;
}

/* Ensure modal is properly layered */
#submit-dialog {
    z-index: 9999;
}

#submit-dialog .bg-white {
    position: relative;
    z-index: 10000;
}

/* Improve button interactions */
button:disabled {
    cursor: not-allowed;
    opacity: 0.6;
}

/* Smooth modal animations */
#submit-dialog {
    animation: fadeIn 0.3s ease-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

/* Hide scrollbars but keep functionality */
.desktop-window::-webkit-scrollbar {
    width: 8px;
}

.desktop-window::-webkit-scrollbar-track {
    background: #f1f1f1;
}

.desktop-window::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

.desktop-window::-webkit-scrollbar-thumb:hover {
    background: #555;
}
</style>
{% endblock %}
